<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>帐号设置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="达达问答">
    <meta name="description" content="达达数据结构专业问答">
    <link rel="stylesheet" href="../../res/layui/css/layui.css">
    <link rel="stylesheet" href="../../res/css/global.css">
    <style>
        #uploadImg {
            position: absolute;
            left: 50%;
            top: 35px;
            margin: 0 0 0 -56px;
        }

        .layui-form-radio * {
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="fly-header layui-bg-black">
    <div class="layui-container">
        <a class="fly-logo" href="../index.html">
            <img width="180" src="../../res/images/fao.png" alt="达达问答">
        </a>

        <ul class="layui-nav fly-nav-user">
            <!-- 登入后的状态 -->
            <li class="layui-nav-item">
                <a class="fly-nav-avatar" href="javascript:;">
                    <cite class="layui-hide-xs">
                        <!--                        <span class="layui-badge-dot"></span>-->
                    </cite>
                    <i class="layui-badge fly-badge-vip layui-bg-blue layui-hide-xs"></i>
                    <img id="titleImg"
                         src="http://148.70.8.85/group1/M00/00/00/rBsAAlyd2OqAfMy_AAAGveq-234459.jpg">
                </a>
                <div id="tip-header-wrapper" style="display:none">
                    <span class="layui-badge-dot" style="right: -16px"></span>
                </div>
                <dl class="layui-nav-child">
                    <dd><a href="../user/set.html"><i class="layui-icon">&#xe620;</i>基本设置</a></dd>
                    <dd>
                        <a href="../user/message.html">
                            <i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的通知
                            <!--                            <span class="layui-badge-dot"></span>-->
                            <span id="tip-header-notice" style="display:none">
                                 <span class="layui-badge-dot"></span>
                            </span>
                        </a>
                    </dd>
                    <dd><a href="../user/home.html"><i class="layui-icon"
                                                       style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a>
                    </dd>
                    <hr style="margin: 5px 0;">
                    <dd>
                        <a href="javascript:void(0);" id="tuichu" style="text-align: center;">退出</a>
                    </dd>
                </dl>
            </li>
        </ul>
    </div>
</div>

<div class="layui-container fly-marginTop fly-user-main">
    <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="user">
        <li class="layui-nav-item">
            <a href="home.html">
                <i class="layui-icon">&#xe609;</i>
                我的主页
            </a>
        </li>
        <li class="layui-nav-item ">
            <a href="index.html">
                <i class="layui-icon">&#xe612;</i>
                用户中心
            </a>
        </li>
        <li class="layui-nav-item layui-this">
            <a href="set.html">
                <i class="layui-icon">&#xe620;</i>
                基本设置
            </a>
        </li>
        <li class="layui-nav-item">
            <a href="message.html">
                <i class="layui-icon">&#xe667;</i>
                我的通知
                <span id="tip-left-notice">
                </span>
            </a>
        </li>
        <li class="layui-nav-item">
            <a href="care.html">
                <i class="layui-icon">&#xe770;</i>
                我的关注
            </a>
        </li>
    </ul>

    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>

    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>


    <div class="fly-panel fly-panel-user" pad20>
        <div class="layui-tab layui-tab-brief" lay-filter="user">
            <ul class="layui-tab-title" id="LAY_mine">
                <li class="layui-this" lay-id="info">我的资料</li>
                <li lay-id="avatar">头像</li>
                <li lay-id="pass">密码</li>
                <!--<li lay-id="bind">帐号绑定</li>-->
            </ul>
            <div class="layui-tab-content" style="padding: 20px 0;">
                <div class="layui-form layui-form-pane layui-tab-item layui-show">
                    <form method="post" action="/myPage/user/userInformation">
                        <input type="text" id="L_userInfoId" hidden name="userInfoId" value="">
                        <div class="layui-form-item">
                            <label for="L_phone" class="layui-form-label">手机</label>
                            <div class="layui-input-inline">
                                <input type="text" id="L_phone"
                                       autocomplete="off"
                                       value=""
                                       class="layui-input"
                                       disabled="" style="cursor: not-allowed !important;">
                            </div>
                            <div class="layui-form-mid layui-word-aux"><span style="color: #5FB878">您已完成手机号绑定，已正式成为实名用户。</span>
                                手机号不支持修改。
                            </div>
                        </div>
                        <div class="layui-form-item"><label for="L_username"
                                                            class="layui-form-label">昵称</label>
                            <div class="layui-input-inline"><input type="text" id="L_username"
                                                                   required=""
                                                                   lay-verify="required"
                                                                   autocomplete="off" value=""
                                                                   class="layui-input"
                                                                   disabled=""
                                                                   style="cursor: not-allowed !important;"
                            ></div>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="radio" name="sex" value="男" title="男">
                                    <div class="layui-unselect layui-form-radio"><i
                                            class="layui-anim layui-icon"></i>
                                        <div style="font-size: 20px">男</div>
                                    </div>
                                    <input type="radio" name="sex" value="女" title="女">
                                    <div class="layui-unselect layui-form-radio"><i
                                            class="layui-anim layui-icon"></i>
                                        <div>女</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_name" class="layui-form-label">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" id="L_name" name="name" autocomplete="off"
                                       value="" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_birthday" class="layui-form-label">出生日期</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="L_birthday"
                                       name="birthday" placeholder="yyyy-MM-dd">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_school" class="layui-form-label">学校</label>
                            <div class="layui-input-inline">
                                <input type="text" id="L_school" name="school" autocomplete="off"
                                       value="" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_school_number" class="layui-form-label">学号</label>
                            <div class="layui-input-inline">
                                <input type="text" id="L_school_number" name="schoolNumber"
                                       autocomplete="off"
                                       value="" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <button class="layui-btn" key="set-mine" lay-filter="updateUserInfo"
                                    lay-submit>
                                确认修改
                            </button>
                        </div>
                    </form>
                </div>
                <div class="layui-form layui-form-pane layui-tab-item">

                    <div class="layui-form-item">
                        <div class="avatar-add">
                            <p>建议尺寸168*168，支持jpg、png、gif，最大不能超过1M</p>
                            <button type="button" id="uploadImg" class="layui-btn ">
                                <i class="layui-icon">&#xe67c;</i>上传头像
                            </button>
                            <img id="showAvatar"
                                 src="http://148.70.8.85/group1/M00/00/00/rBsAAlyd2OqAfMy_AAAGveq-234459.jpg">
                            <span class="loading"></span>
                        </div>
                    </div>

                </div>
                <div class="layui-form layui-form-pane layui-tab-item">
                    <form action="/userAccount/change/web/password" method="post">
                        <div class="layui-form-item">
                            <label for="L_nowpass" class="layui-form-label">当前密码</label>
                            <div class="layui-input-inline">
                                <input type="password" id="L_nowpass" name="oldPass" required
                                       lay-verify="required" autocomplete="off"
                                       class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_pass" class="layui-form-label">新密码</label>
                            <div class="layui-input-inline">
                                <input type="password" id="L_pass" name="newPass" required
                                       lay-verify="password|required" autocomplete="off"
                                       class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">6到12个字符</div>
                        </div>
                        <div class="layui-form-item">
                            <label for="L_repass" class="layui-form-label">确认密码</label>
                            <div class="layui-input-inline">
                                <input type="password" id="L_repass" name="repass" required
                                       lay-verify="repassword|required" autocomplete="off"
                                       class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <button class="layui-btn" key="set-mine" lay-filter="changePass"
                                    lay-submit>
                                确认修改
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="fly-footer">
    <p><a href="#" target="_blank">达达问答</a> 2019 &copy; <a
            href="#" target="_blank">dada.com 出品</a></p>
</div>

<script src="../../layui/layui.all.js"></script>
<script>
    layui.config({
        version: "2.4.5"
        , base: '../../res/mods/'
    }).extend({
        fly: 'index'
    }).use(['fly'], function () {
        let $ = layui.jquery;
        let fly = layui.fly;
        let form = layui.form;
        let laydate = layui.laydate;
        let upload = layui.upload;

        // 表单验证
        form.verify({
            password: [
                /^[\S]{6,12}$/
                , '密码必须6到12位'
            ],
            repassword: function (value) {
                let repassValue = $('#L_pass').val();
                if (value != repassValue) {
                    return '两次输入的密码不一致!'
                }
            }
        });

        // 设置个人信息
        function setUserInfomation(userInfo) {
            $('#L_username').val(localStorage.getItem('username'));
            if (!userInfo) {
                return
            }
            $('#L_userInfoId').val(userInfo.id);
            $('#L_phone').val(userInfo.telephone);
            $('[name=sex]').each(function (i, item) {
                if ($(item).val() === userInfo.sex) {
                    $(item).prop('checked', true);
                    form.render();
                }
            });
            console.log(userInfo)
            $('#L_name').val(userInfo.name);
            if (userInfo.birthday) {
                laydate.render({
                    elem: '#L_birthday',
                    value: new Date(userInfo.birthday)
                });
            }
            $('#L_school').val(userInfo.school);
            $('#L_school_number').val(userInfo.schoolNumber);
        }

        fly.json('/myPage/user/userInformation', null, function (res) {
            layui.cache.userInformation = res.body.data;
            setUserInfomation(layui.cache.userInformation)
        }, {type: 'get'});


        let tempUser = layui.cache.token;
        tempUser.username = '';
        // 上传头像
        let uploadInst = upload.render({
            elem: '#uploadImg'
            , url: layui.baseUrl() + '/myPage/upload/avatar'
            , field: 'files'
            , headers: {authorization: JSON.stringify(tempUser)}
            , before: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#showAvatar').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res) {
                layer.msg("上传成功!", {icon: 1});
                localStorage.setItem('token', JSON.stringify(res.body.data));
                $('#titleImg').attr('src', layui.imgUrl() + res.body.data.avatar)
            }
            , error: function (err) {
                console.log(err)
                //演示失败状态，并实现重传
                layer.msg("上传失败!", {icon: 2});
            }
        });

    });
</script>

</body>
</html>
